<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل راننده - ردیاب GPS</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRS9BMY="
     crossorigin=""/>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Tahoma', sans-serif; }
        
        #map { width: 100%; height: 100vh; z-index: 1; }

        .control-panel {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            width: 80%;
            max-width: 400px;
            justify-content: space-between;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            background-color: #bdc3c7; /* خاکستری پیش‌فرض */
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-active { background-color: #2ecc71; } /* سبز برای فعال */
        .status-error { background-color: #e74c3c; } /* قرمز برای خطا */

        #status-msg {
            font-size: 0.9rem;
            font-weight: bold;
            color: #333;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
            100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="control-panel">
        <div id="status-indicator" class="status-dot"></div>
        <span id="status-msg">در انتظار دریافت مجوز GPS...</span>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script>
        // ۱. راه‌اندازی نقشه
        // ابتدا نقشه را روی مرکز ایران یا شهر دانشگاه تنظیم می‌کنیم
        const map = L.map('map').setView([32.4279, 53.6880], 5); 

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(map);

        // ۲. آیکون اتوبوس
        const busIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/3448/3448339.png',
            iconSize: [40, 40],
            iconAnchor: [20, 20],
            popupAnchor: [0, -20]
        });

        // متغیرهای ذخیره وضعیت
        let busMarker = null;
        let accuracyCircle = null;
        let pathLine = L.polyline([], {color: 'red'}).addTo(map); // خط قرمز برای رسم مسیر طی شده

        // ۳. تنظیمات GPS
        const geoOptions = {
            enableHighAccuracy: true, // درخواست دقیق‌ترین حالت ممکن (استفاده از GPS واقعی)
            maximumAge: 0,            // عدم استفاده از مکان کش شده
            timeout: 10000            // تایم‌اوت ۱۰ ثانیه
        };

        // ۴. تابع شروع ردیابی
        function startTracking() {
            if (!navigator.geolocation) {
                updateStatus("مرورگر شما از GPS پشتیبانی نمی‌کند.", "error");
                return;
            }

            updateStatus("در حال دریافت موقعیت مکانی...", "normal");

            // استفاده از watchPosition به جای getCurrentPosition
            // این تابع هر بار که مکان تغییر کند، اجرا می‌شود
            navigator.geolocation.watchPosition(successPosition, errorPosition, geoOptions);
        }

        // ۵. کال‌بک موفقیت (مکان پیدا شد)
        function successPosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy; // دقت به متر

            updateStatus(`موقعیت دریافت شد (دقت: ${Math.round(accuracy)} متر)`, "active");

            // اگر بار اول است که مارکر ساخته می‌شود
            if (!busMarker) {
                busMarker = L.marker([lat, lng], {icon: busIcon}).addTo(map);
                accuracyCircle = L.circle([lat, lng], {radius: accuracy}).addTo(map);
                map.setView([lat, lng], 16); // زوم روی اتوبوس
            } else {
                // آپدیت مکان مارکر و دایره دقت
                busMarker.setLatLng([lat, lng]);
                accuracyCircle.setLatLng([lat, lng]);
                accuracyCircle.setRadius(accuracy);
                
                // نقشه را نرم حرکت بده به سمت اتوبوس
                map.panTo([lat, lng]);
            }

            // رسم خط مسیر پشت سر اتوبوس
            pathLine.addLatLng([lat, lng]);
        }

        // ۶. کال‌بک خطا (مشکل در GPS)
        function errorPosition(err) {
            let message = "";
            switch(err.code) {
                case err.PERMISSION_DENIED:
                    message = "کاربر اجازه دسترسی به GPS را نداد.";
                    break;
                case err.POSITION_UNAVAILABLE:
                    message = "مکان‌یابی امکان‌پذیر نیست (GPS خاموش است؟).";
                    break;
                case err.TIMEOUT:
                    message = "زمان درخواست تمام شد.";
                    break;
                default:
                    message = "خطای ناشناخته رخ داد.";
            }
            updateStatus(message, "error");
            console.warn(`ERROR(${err.code}): ${err.message}`);
        }

        // تابع کمکی برای آپدیت متن وضعیت
        function updateStatus(text, type) {
            const msgEl = document.getElementById('status-msg');
            const dotEl = document.getElementById('status-indicator');
            
            msgEl.innerText = text;
            
            dotEl.classList.remove('status-active', 'status-error');
            if (type === 'active') dotEl.classList.add('status-active');
            if (type === 'error') dotEl.classList.add('status-error');
        }

        // شروع خودکار بعد از لود شدن صفحه
        // نکته: در برخی مرورگرها ممکن است نیاز باشد کاربر دکمه‌ای را بزند، اما معمولا برای GPS دیالوگ باز می‌شود.
        startTracking();

    </script>
</body>
</html>